# √öltimas Actualizaciones - 26 de junio de 2025

## üé® Splash Screen Implementado
Se agreg√≥ una pantalla de bienvenida animada que mejora significativamente la experiencia de usuario:
- Duraci√≥n: 4 segundos en primera carga por sesi√≥n
- Animaciones: Logo flotante, gradientes corporativos, efectos de glow
- Integraci√≥n: app/RootWrapper.tsx modificado con hook personalizado
- Componentes: SplashScreen.tsx y useSplashScreen.tsx
- UX: Solo se muestra una vez por sesi√≥n, transici√≥n autom√°tica

## üêõ Correcciones de TypeScript
Resueltos errores de tipos en ReceptionToPrint.tsx:
- availableBonus ‚Üí availableBonificacion
- availableDry ‚Üí availableSecado
- Alineaci√≥n completa con tipos TemplateType

## üéØ Mejoras de UI
Corregida alineaci√≥n de √≠conos en tabla de plantillas (SelectTemplate.tsx):
- √çconos horizontalmente alineados usando flexbox
- Mejor experiencia visual en gesti√≥n de plantillas
- Consistencia mejorada en la interfaz

## üìä Verificaci√≥n de Cache
Confirmada configuraci√≥n de cache en productores:
- getAllProducers() usa cache: "no-store"
- Datos siempre actualizados desde servidor
- Optimal para datos din√°micos

## üßπ Limpieza de C√≥digo
- Revertidos scripts experimentales de creaci√≥n masiva de plantillas
- C√≥digo base m√°s limpio y enfocado
- Documentaci√≥n actualizada y organizada

---

# An√°lisis de ParamCells: Arquitectura y L√≥gica

El archivo `hooks/paramCells.tsx` implementa un sistema sofisticado de c√°lculo para el procesamiento de arroz (paddy), utilizando un patr√≥n de dise√±o basado en nodos reactivos.

## Estructura principal

El c√≥digo organiza los datos y c√°lculos en dos niveles principales:

1. **Clusters**: Representan categor√≠as o grupos de par√°metros relacionados (ej: Humedad, Granos Verdes, etc.)
2. **Nodos**: Componentes individuales dentro de cada cluster que contienen valores y funciones espec√≠ficas

## Tipos de Clusters

- `GenericCluster`: Para valores simples como precio, peso bruto
- `ParamCluster`: Para par√°metros que requieren rango, porcentaje, tolerancia y penalizaci√≥n
- `GroupSummaryCluster`: Para totales de grupos de par√°metros
- `SummaryCluster`: Para res√∫menes de todos los an√°lisis
- `BonusCluster`: Para bonificaciones
- `DryCluster`: Para c√°lculos de secado

## Tipos de Nodos

- `generic`: Nodos gen√©ricos para valores simples
- `range`: Para rangos de valores
- `percent`: Para porcentajes
- `tolerance`: Para valores de tolerancia
- `penalty`: Para penalizaciones calculadas

## Sistema de Propagaci√≥n Reactiva

La arquitectura implementa un sistema reactivo donde:

1. Cada nodo tiene `nodeSources` (nodos que lo alimentan) y `nodeConsumers` (nodos que consumen su valor)
2. Cuando un nodo cambia, notifica a sus consumidores a trav√©s de `effect()`
3. Los consumidores recalculan sus valores y propagan los cambios

Por ejemplo, cuando cambias los valores de `grossWeight` o `tare`, esto dispara el rec√°lculo autom√°tico de `netWeight`, que a su vez afecta los c√°lculos de penalizaci√≥n.

## L√≥gica de C√°lculo Principal

- Cada par√°metro (Humedad, Granos Verdes, etc.) tiene un nodo de rango que determina su porcentaje
- El porcentaje menos la tolerancia determina la penalizaci√≥n efectiva
- Las penalizaciones se calculan como un porcentaje del peso neto
- El sistema suma todas las penalizaciones para calcular descuentos totales

## Validaci√≥n y Feedback Visual

El sistema incluye validaci√≥n de datos con feedback visual:
- Porcentajes mayores a 100% generan errores visuales
- Tolerancias mayores que los porcentajes generan errores
- Penalizaciones totales mayores que el peso neto generan errores

Este sistema permite una interfaz de usuario reactiva donde los cambios en cualquier par√°metro se propagan autom√°ticamente a trav√©s de toda la cadena de c√°lculos, manteniendo consistencia en todos los valores relacionados.

# Sistema de Plantillas (Templates) en la Aplicaci√≥n de Recepci√≥n de Arroz

El sistema de plantillas es un componente fundamental que permite configurar par√°metros predefinidos para el an√°lisis de granos de arroz. Estas plantillas se pueden asociar a productores espec√≠ficos para agilizar el proceso de recepci√≥n.

## Estructura de las Plantillas

Una plantilla (`TemplateType`) contiene:

1. **Informaci√≥n b√°sica**:
   - `id`: Identificador √∫nico
   - `name`: Nombre de la plantilla
   - `producerId`: ID del productor asociado
   - `useToleranceGroup`: Indicador de uso de tolerancia grupal
   - `groupToleranceValue`: Valor de tolerancia para el grupo

2. **Configuraci√≥n para cada par√°metro** (Humedad, Granos Verdes, Impurezas, etc.):
   - `available[Par√°metro]`: Si el par√°metro est√° disponible/activo
   - `percent[Par√°metro]`: Valor porcentual base del par√°metro
   - `tolerance[Par√°metro]`: Valor de tolerancia espec√≠fico
   - `showTolerance[Par√°metro]`: Si se muestra la tolerancia
   - `groupTolerance[Par√°metro]`: Si el par√°metro usa tolerancia grupal

## Componentes principales de las plantillas

### 1. `SelectTemplate.tsx`
- Permite al usuario buscar y seleccionar plantillas existentes
- Muestra una lista de plantillas filtrable por productor
- Permite marcar plantillas como favoritas/predeterminadas
- Ofrece funcionalidad para eliminar plantillas

### 2. `Template.tsx`
- Permite crear nuevas plantillas
- Incluye campos para nombre y productor asociado
- Integra `TemplateTable` para configurar los par√°metros

### 3. `TemplateTable.tsx`
- Muestra una tabla interactiva con todos los par√°metros configurables
- Permite habilitar/deshabilitar par√°metros individualmente
- Permite configurar porcentajes y tolerancias para cada par√°metro
- Soporta la configuraci√≥n de tolerancia grupal

### 4. `SelectedTemplateTable.tsx`
- Muestra los detalles de una plantilla seleccionada
- Permite aplicar la plantilla a la recepci√≥n actual

## Integraci√≥n con el sistema de paramCells

Las plantillas se conectan con el sistema `paramCells` a trav√©s del hook `useReceptionData`:

1. Cuando se selecciona una plantilla, sus valores se cargan en el contexto de recepci√≥n
2. Estos valores configuran los nodos correspondientes en `paramCells`
3. Por ejemplo, si `availableHumedad` es `true` y tiene un valor de `percentHumedad` de 14%, estos valores inicializan los nodos de humedad en `paramCells`
4. Los valores de tolerancia de la plantilla configuran los nodos de tolerancia correspondientes
5. La arquitectura reactiva de `paramCells` se encarga de propagar estos valores iniciales a trav√©s del sistema de c√°lculo

## Flujo de uso t√≠pico

1. El usuario inicia una nueva recepci√≥n
2. Selecciona un productor
3. Selecciona una plantilla asociada al productor o una plantilla general
4. La plantilla configura autom√°ticamente los par√°metros de an√°lisis de granos
5. El usuario puede ajustar los valores seg√∫n necesidades espec√≠ficas
6. Los c√°lculos se realizan autom√°ticamente seg√∫n la configuraci√≥n de la plantilla

Las plantillas esencialmente funcionan como "presets" que configuran todo el sistema de c√°lculo de `paramCells`, ahorrando tiempo al usuario y asegurando consistencia en las recepciones para un mismo productor o tipo de arroz.

# Sistema de Validaci√≥n y Errores en GrainAnalysis

El componente GrainAnalysis implementa un sistema integral de validaci√≥n que garantiza la integridad de los datos ingresados y proporciona retroalimentaci√≥n visual inmediata al usuario.

## Tipos de Errores de Validaci√≥n

### 1. Errores de Par√°metros Individuales

#### Error de Porcentaje Mayor a 100%
- **Cu√°ndo ocurre**: Cuando el porcentaje de cualquier par√°metro individual (Humedad, Granos Verdes, Impurezas, etc.) supera el 100%
- **Campo afectado**: Campo de porcentaje del par√°metro espec√≠fico
- **Mensaje visual**: Fondo rojo claro (`#ffcdd2`) en el campo de porcentaje

#### Error de Tolerancia Mayor que Porcentaje
- **Cu√°ndo ocurre**: Cuando el valor de tolerancia es mayor que el porcentaje medido del mismo par√°metro
- **Campo afectado**: Campo de tolerancia del par√°metro espec√≠fico
- **Mensaje visual**: Fondo rojo claro (`#ffcdd2`) en el campo de tolerancia

### 2. Errores de Resumen Total

#### Error de Porcentaje Total Mayor a 100%
- **Cu√°ndo ocurre**: Cuando la suma de todos los porcentajes individuales de par√°metros supera el 100%
- **Campo afectado**: Campo de porcentaje en la fila "Resumen Total"
- **Mensaje visual**: Fondo rojo claro en el campo de porcentaje del resumen

#### Error de Tolerancia Total Mayor a 100%
- **Cu√°ndo ocurre**: Cuando la suma de todas las tolerancias individuales supera el 100%
- **Campo afectado**: Campo de tolerancia en la fila "Resumen Total"
- **Mensaje visual**: Fondo rojo claro en el campo de tolerancia del resumen

### 3. Errores de Grupo de Tolerancia

#### Error de Porcentaje de Grupo Mayor a 100%
- **Cu√°ndo ocurre**: Cuando la suma de los porcentajes de los par√°metros que pertenecen al grupo de tolerancia supera el 100%
- **Campo afectado**: Campo de porcentaje en la fila "Resumen de Grupo"
- **Mensaje visual**: Fondo rojo claro en el campo de porcentaje del resumen de grupo

#### Error de Tolerancia de Grupo Mayor que Porcentaje de Grupo
- **Cu√°ndo ocurre**: Cuando la tolerancia total del grupo de tolerancia supera al porcentaje total del grupo de tolerancia
- **Campo afectado**: Campo de tolerancia en la fila "Resumen de Grupo"
- **Mensaje visual**: Fondo rojo claro en el campo de tolerancia del resumen de grupo

### 4. Errores de Validaci√≥n de Datos

#### Error de Valor No Num√©rico
- **Cu√°ndo ocurre**: Cuando se ingresa un valor que no es un n√∫mero v√°lido
- **Campo afectado**: Cualquier campo num√©rico (porcentaje, tolerancia, rango)
- **Comportamiento**: El sistema convierte autom√°ticamente valores inv√°lidos a 0

#### Error de Valor Negativo
- **Cu√°ndo ocurre**: Cuando se ingresa un valor negativo en campos que solo aceptan valores positivos
- **Campo afectado**: Campos de porcentaje, tolerancia y rango
- **Comportamiento**: El sistema autom√°ticamente convierte valores negativos a 0

### 5. Errores de Consistencia L√≥gica

#### Error de Suma Inconsistente
- **Cu√°ndo ocurre**: Cuando los c√°lculos agregados no coinciden con la suma de los componentes individuales
- **Campo afectado**: Campos de resumen y totales
- **Comportamiento**: El sistema recalcula autom√°ticamente los valores

#### Error de Penalizaci√≥n Excesiva
- **Cu√°ndo ocurre**: Cuando las penalizaciones calculadas superan el peso neto disponible
- **Campo afectado**: Campos de penalizaci√≥n (castigo en kg)
- **Comportamiento**: Advertencia visual en los campos afectados

## Sistema de Colores para Grupos de Tolerancia

El sistema implementa una l√≥gica especial de colores para los campos que pertenecen al grupo de tolerancia:

### Estados de Color
- **Estado Normal (sin grupo de tolerancia)**: Fondo por defecto (`inherit`)
- **Estado Normal (con grupo de tolerancia)**: Fondo p√∫rpura claro (`#ede7f6`)
- **Estado de Error**: Fondo rojo claro (`#ffcdd2`) independientemente del grupo

### L√≥gica de Color
```
si (hay_error) {
    color = rojo_claro (#ffcdd2)
} sino si (pertenece_a_grupo_tolerancia) {
    color = p√∫rpura_claro (#ede7f6)
} sino {
    color = por_defecto (inherit)
}
```

## Arquitectura de Validaci√≥n

### Sistema Reactivo
- **Validaci√≥n en Tiempo Real**: Los errores aparecen y desaparecen inmediatamente al cambiar los valores
- **Propagaci√≥n Autom√°tica**: Los cambios en un campo activan validaciones en campos relacionados
- **Recuperaci√≥n Autom√°tica**: Los errores se corrigen autom√°ticamente cuando se ingresan valores v√°lidos

### Funciones de Efecto
Cada par√°metro tiene una funci√≥n `effect` que se ejecuta cuando cambian sus dependencias:
- Valida los valores actuales
- Establece el estado de error correspondiente
- Actualiza los colores de fondo seg√∫n el estado y grupo de tolerancia
- Propaga los cambios a nodos dependientes

### Jerarqu√≠a de Validaci√≥n
1. **Nivel de Campo**: Validaci√≥n individual de porcentaje y tolerancia
2. **Nivel de Par√°metro**: Validaci√≥n cruzada entre porcentaje y tolerancia
3. **Nivel de Grupo**: Validaci√≥n agregada del grupo de tolerancia
4. **Nivel de Sistema**: Validaci√≥n del resumen total

## Prioridad de Errores

1. **M√°s Cr√≠tico**: Errores de l√≥gica (tolerancia > porcentaje)
2. **Cr√≠tico**: Errores de l√≠mites (porcentajes > 100%)
3. **Moderado**: Errores de agregaci√≥n (sumas > 100%)
4. **Menor**: Errores de formato (valores no num√©ricos)

## Beneficios del Sistema

- **Integridad de Datos**: Previene la entrada de datos inv√°lidos o inconsistentes
- **Experiencia de Usuario**: Retroalimentaci√≥n visual inmediata y clara
- **Automatizaci√≥n**: No requiere intervenci√≥n manual para limpiar errores
- **Escalabilidad**: F√°cil agregar nuevas validaciones siguiendo el patr√≥n existente
- **Consistencia**: Comportamiento uniforme en todos los campos y par√°metros

Este sistema de validaci√≥n integral asegura que los datos ingresados en el an√°lisis de granos sean siempre coherentes y v√°lidos, mejorando la confiabilidad de los c√°lculos de descuentos y penalizaciones.

# Mecanismo de Bonus (Bonificaci√≥n) en el An√°lisis de Granos

El sistema de Bonus o Bonificaci√≥n es un componente especial dentro del an√°lisis de granos que permite otorgar un beneficio al productor, a√±adiendo kilos en lugar de restarlos como ocurre con las penalizaciones.

## Concepto y C√°lculo

1. **Definici√≥n**: El Bonus es un porcentaje configurable que se aplica al peso neto del arroz como un valor positivo.
2. **C√°lculo**: Se determina mediante la f√≥rmula: `(toleranceBonus * netWeight) / 100`
3. **Efecto**: Aumenta directamente la cantidad de kilos que se pagar√°n al productor.
4. **Flujo de c√°lculo final**:
   ```
   Paddy neto = Peso neto - Total descuentos + Bonificaci√≥n
   ```

## Representaci√≥n en la Interfaz

- Se muestra como una fila independiente llamada "Bonificaci√≥n" despu√©s del "Total An√°lisis"
- Visualmente se destaca como un beneficio, no como una penalizaci√≥n
- En los informes impresos aparece como una l√≠nea adicional en el resumen final
- Solo se muestra si tiene un valor positivo mayor que cero

## Reglas y Restricciones de Aplicaci√≥n

1. **Configuraci√≥n**:
   - Se activa/desactiva mediante la propiedad `availableBonus` en las plantillas
   - Su valor se define manualmente a trav√©s del campo `toleranceBonus`
   - No posee rangos autom√°ticos ni valores predeterminados como otros par√°metros

2. **Comportamiento**:
   - No tiene campo de porcentaje medido, solo tolerancia
   - No forma parte del grupo de tolerancia
   - Siempre act√∫a como un valor positivo (nunca penaliza)
   - No se muestra en los reportes si su valor es cero

3. **Limitaciones**:
   - No permite configurar rangos o escalas progresivas
   - No tiene validaciones especiales como otros par√°metros
   - No se conecta a otros par√°metros del an√°lisis

## Implementaci√≥n T√©cnica

1. **Estructura de datos**:
   - Se implementa como un cluster especial de tipo `BonusCluster` en `paramCells.tsx`
   - Tiene una estructura m√°s simple que otros par√°metros:
     ```typescript
     const cluster: BonusCluster = {
       key: key,
       available: available,
       showTolerance,
       toleranceGroup,
       type: "bonus",
       name: "Bonificaci√≥n",
       tolerance: undefined as any,
       penalty: undefined as any,
     };
     ```
   - Solo contiene nodos de tolerancia y penalizaci√≥n (a diferencia de otros par√°metros que tienen nodo de porcentaje)
   - El valor de penalizaci√≥n es siempre positivo, representando una adici√≥n

2. **Flujo de datos**:
   - Los valores se configuran desde las plantillas mediante las propiedades `availableBonus` y `toleranceBonus`
   - El sistema propaga los cambios a trav√©s del sistema reactivo de nodos
   - La penalizaci√≥n (valor en kilos) se calcula autom√°ticamente basado en el peso neto

3. **Integraci√≥n en el sistema**:
   - En el frontend se renderiza condicionalmente basado en su disponibilidad
   - En los c√°lculos finales se suma despu√©s de restar todos los descuentos
   - Se utiliza directamente en los informes impresos y res√∫menes

Esta implementaci√≥n flexible permite que el Bonus funcione como un mecanismo de compensaci√≥n adicional que puede activarse o desactivarse seg√∫n necesidad, otorgando mayor control sobre el precio final pagado al productor.
